{% extends "base.html" %}

{% block title %}FACE REGISTRATION - FaceLogged Cyber System{% endblock %}

{% block content %}
<style>
    .registration-container {
        max-width: 900px;
        margin: 0 auto;
    }
    
    .student-info-card {
        background: rgba(17, 17, 34, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(0, 243, 255, 0.2);
        border-radius: 12px;
        margin-bottom: 2rem;
    }
    
    .instructions-card {
        background: rgba(255, 193, 7, 0.1);
        border: 1px solid rgba(255, 193, 7, 0.3);
        border-radius: 12px;
        margin-bottom: 2rem;
    }
    
    .camera-section {
        background: rgba(17, 17, 34, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(0, 243, 255, 0.2);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        text-align: center;
    }
    
    .camera-feed {
        border: 2px solid rgba(0, 243, 255, 0.3);
        border-radius: 12px;
        max-height: 400px;
        background: #000;
    }
    
    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-family: 'Orbitron', monospace;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.9rem;
        margin-top: 1rem;
    }
    
    .status-active {
        background: rgba(0, 255, 136, 0.1);
        color: var(--terminal-green);
        border: 1px solid rgba(0, 255, 136, 0.3);
    }
    
    .status-processing {
        background: rgba(255, 193, 7, 0.1);
        color: #ffc107;
        border: 1px solid rgba(255, 193, 7, 0.3);
    }
    
    .status-success {
        background: rgba(0, 255, 136, 0.1);
        color: var(--terminal-green);
        border: 1px solid rgba(0, 255, 136, 0.3);
    }
    
    .status-error {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
        border: 1px solid rgba(220, 53, 69, 0.3);
    }
    
    .progress-section {
        background: rgba(17, 17, 34, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(0, 243, 255, 0.2);
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1rem;
    }
    
    .progress-bar-cyber {
        height: 12px;
        background: rgba(0, 243, 255, 0.1);
        border-radius: 6px;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--cyber-blue), var(--cyber-purple));
        border-radius: 6px;
        transition: width 0.3s ease;
        width: 0%;
    }
    
    .tips-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .tip-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: rgba(0, 243, 255, 0.05);
        border: 1px solid rgba(0, 243, 255, 0.1);
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .tip-item:hover {
        background: rgba(0, 243, 255, 0.1);
        border-color: var(--cyber-blue);
        transform: translateY(-2px);
    }
    
    .tip-icon {
        width: 40px;
        height: 40px;
        background: rgba(0, 243, 255, 0.1);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--cyber-blue);
        font-size: 1.2rem;
        flex-shrink: 0;
    }
</style>

<div class="page-header">
    <h1 class="page-title">FACE REGISTRATION</h1>
    <div class="page-subtitle">BIOMETRIC IDENTITY ENROLLMENT</div>
</div>

<div class="registration-container">
    <!-- Student Information -->
    <div class="student-info-card">
        <div class="card-body">
            <div class="d-flex align-items-center">
                <div class="student-avatar" style="width: 70px; height: 70px;">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <div class="ms-3">
                    <h4 class="cyber-text mb-1">{{ student[0] }} {{ student[1] }}</h4>
                    <p class="text-terminal mb-0">STUDENT ID: {{ student[2] }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Instructions -->
    <div class="instructions-card">
        <div class="card-body">
            <div class="d-flex">
                <i class="fas fa-info-circle fa-2x text-warning me-3 mt-1"></i>
                <div>
                    <h5 class="cyber-text mb-3">REGISTRATION REQUIREMENTS</h5>
                    <div class="tips-grid">
                        <div class="tip-item">
                            <div class="tip-icon">
                                <i class="fas fa-sun"></i>
                            </div>
                            <div>
                                <h6 class="mb-1 text-light">GOOD LIGHTING</h6>
                                <p class="text-muted mb-0">Ensure even lighting on face</p>
                            </div>
                        </div>
                        <div class="tip-item">
                            <div class="tip-icon">
                                <i class="fas fa-eye"></i>
                            </div>
                            <div>
                                <h6 class="mb-1 text-light">FACE CAMERA</h6>
                                <p class="text-muted mb-0">Look directly at camera</p>
                            </div>
                        </div>
                        <div class="tip-item">
                            <div class="tip-icon">
                                <i class="fas fa-hat-cowboy"></i>
                            </div>
                            <div>
                                <h6 class="mb-1 text-light">NO ACCESSORIES</h6>
                                <p class="text-muted mb-0">Remove hats & sunglasses</p>
                            </div>
                        </div>
                        <div class="tip-item">
                            <div class="tip-icon">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <h6 class="mb-1 text-light">SINGLE PERSON</h6>
                                <p class="text-muted mb-0">Only one face in frame</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera Section -->
    <div class="camera-section">
        <h4 class="cyber-text mb-4">
            <i class="fas fa-camera me-2"></i>BIOMETRIC CAPTURE
        </h4>
        
        <img id="cameraFeed" src="{{ url_for('video_feed') }}" class="camera-feed img-fluid">
        
        <div class="mt-3">
            <span id="faceStatus" class="status-indicator status-active">
                <i class="fas fa-circle"></i> CAMERA ACTIVE
            </span>
        </div>
    </div>

    <!-- Capture Button -->
    <div class="text-center mb-4">
        <button id="captureBtn" class="btn btn-submit btn-lg px-5 py-3">
            <i class="fas fa-camera me-2"></i> CAPTURE & REGISTER FACE
        </button>
        <a href="{{ url_for('student_dashboard') }}" class="btn btn-cancel btn-lg ms-3 px-5 py-3">
            <i class="fas fa-times me-2"></i> CANCEL
        </a>
    </div>

    <!-- Progress Section -->
    <div id="progressSection" class="progress-section d-none">
        <div class="progress-bar-cyber mb-3">
            <div id="progressFill" class="progress-fill"></div>
        </div>
        <div id="progressMessage" class="text-center cyber-text"></div>
    </div>
</div>

<script>
document.getElementById('captureBtn').addEventListener('click', function() {
    const btn = this;
    const progressSection = document.getElementById('progressSection');
    const progressFill = document.getElementById('progressFill');
    const progressMessage = document.getElementById('progressMessage');
    const faceStatus = document.getElementById('faceStatus');

    // Disable button and show progress
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> PROCESSING...';
    progressSection.classList.remove('d-none');
    
    // Update status
    faceStatus.className = 'status-indicator status-processing';
    faceStatus.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> PROCESSING FACE DETECTION';
    
    // Simulate progress
    let progress = 0;
    const interval = setInterval(() => {
        progress += 10;
        progressFill.style.width = progress + '%';
        
        if (progress <= 30) {
            progressMessage.innerHTML = '<i class="fas fa-camera me-2"></i>INITIALIZING CAMERA SYSTEMS';
        } else if (progress <= 60) {
            progressMessage.innerHTML = '<i class="fas fa-search me-2"></i>ANALYZING FACIAL FEATURES';
        } else if (progress <= 90) {
            progressMessage.innerHTML = '<i class="fas fa-cog me-2"></i>PROCESSING BIOMETRIC DATA';
        }
        
        if (progress >= 100) {
            clearInterval(interval);
            captureFace();
        }
    }, 200);
});

function captureFace() {
    const progressMessage = document.getElementById('progressMessage');
    const faceStatus = document.getElementById('faceStatus');
    
    progressMessage.innerHTML = '<i class="fas fa-database me-2"></i>SECURING DATA STORAGE';
    faceStatus.className = 'status-indicator status-processing';
    faceStatus.innerHTML = '<i class="fas fa-database"></i> SAVING TO DATABASE';
    
    fetch('/capture-face', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            progressMessage.innerHTML = '<span class="text-terminal"><i class="fas fa-check-circle me-2"></i>' + data.message + '</span>';
            faceStatus.className = 'status-indicator status-success';
            faceStatus.innerHTML = '<i class="fas fa-check-circle"></i> REGISTRATION SUCCESSFUL';
            
            setTimeout(() => {
                window.location.href = '/face-registration-success';
            }, 2000);
        } else {
            progressMessage.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>' + data.message + '</span>';
            faceStatus.className = 'status-indicator status-error';
            faceStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> REGISTRATION FAILED';
            
            document.getElementById('captureBtn').disabled = false;
            document.getElementById('captureBtn').innerHTML = '<i class="fas fa-camera me-2"></i> TRY AGAIN';
        }
    })
    .catch(error => {
        progressMessage.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>NETWORK ERROR: ' + error + '</span>';
        faceStatus.className = 'status-indicator status-error';
        faceStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> CONNECTION ERROR';
        
        document.getElementById('captureBtn').disabled = false;
        document.getElementById('captureBtn').innerHTML = '<i class="fas fa-camera me-2"></i> TRY AGAIN';
    });
}
</script>
{% endblock %}