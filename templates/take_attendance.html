{% extends "base.html" %}

{% block title %}ATTENDANCE CAPTURE - {{ module_code }}{% endblock %}

{% block content %}
<style>
    .attendance-session-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .camera-section-attendance {
        background: rgba(17, 17, 34, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(0, 243, 255, 0.2);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        text-align: center;
    }
    
    .camera-feed-attendance {
        border: 3px solid rgba(0, 243, 255, 0.3);
        border-radius: 12px;
        background: #000;
        max-height: 400px;
    }
    
    .recognition-results {
        background: rgba(17, 17, 34, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(0, 243, 255, 0.2);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .result-item {
        display: flex;
        justify-content: between;
        align-items: center;
        padding: 1rem;
        background: rgba(0, 243, 255, 0.05);
        border: 1px solid rgba(0, 243, 255, 0.2);
        border-radius: 8px;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .result-item:hover {
        background: rgba(0, 243, 255, 0.1);
        border-color: var(--cyber-blue);
    }
    
    .session-info-panel {
        background: rgba(17, 17, 34, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(0, 243, 255, 0.2);
        border-radius: 12px;
        padding: 1.5rem;
    }
    
    .info-card {
        background: rgba(0, 243, 255, 0.05);
        border: 1px solid rgba(0, 243, 255, 0.2);
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        margin-bottom: 1rem;
    }
    
    .info-value {
        font-family: 'Orbitron', monospace;
        font-size: 1.5rem;
        color: var(--cyber-blue);
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .info-label {
        font-family: 'Exo 2', sans-serif;
        color: var(--text-light);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.8rem;
    }
    
    .btn-capture-attendance {
        background: linear-gradient(135deg, var(--cyber-blue), var(--cyber-purple));
        border: none;
        border-radius: 8px;
        padding: 1.5rem 3rem;
        font-family: 'Orbitron', monospace;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--dark-bg);
        font-size: 1.2rem;
        transition: all 0.3s ease;
        width: 100%;
    }
    
    .btn-capture-attendance:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(0, 243, 255, 0.4);
        color: var(--dark-bg);
    }
</style>

<div class="page-header">
    <h1 class="page-title">MANUAL ATTENDANCE CAPTURE</h1>
    <div class="page-subtitle">SINGLE-SHOT FACIAL RECOGNITION - {{ module_code }}</div>
</div>

<div class="attendance-session-container">
    <!-- Instructions -->
    <div class="alert alert-info border-0 mb-4">
        <div class="d-flex align-items-center">
            <i class="fas fa-info-circle fa-2x text-info me-3"></i>
            <div>
                <h6 class="fw-bold mb-1">ATTENDANCE CAPTURE INSTRUCTIONS</h6>
                <p class="mb-0">Students should look directly at the camera. Click the capture button to recognize and mark attendance for each student individually.</p>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Camera and Results -->
        <div class="col-lg-8">
            <!-- Camera Section -->
            <div class="camera-section-attendance">
                <img id="cameraFeed" src="{{ url_for('video_feed') }}" 
                     class="camera-feed-attendance img-fluid">
                
                <div class="mt-3">
                    <span id="faceStatus" class="status-indicator status-active">
                        <i class="fas fa-circle"></i> CAMERA ACTIVE - AWAITING CAPTURE
                    </span>
                </div>
                
                <div class="mt-4">
                    <button onclick="markAttendance()" class="btn-capture-attendance">
                        <i class="fas fa-camera me-2"></i> CAPTURE & MARK ATTENDANCE
                    </button>
                </div>
            </div>

            <!-- Recognition Results -->
            <div class="recognition-results">
                <h5 class="cyber-text mb-3">
                    <i class="fas fa-list me-2"></i>RECOGNITION RESULTS
                </h5>
                
                <div id="recognitionResults">
                    <div class="text-center py-4">
                        <div class="empty-icon-ratings" style="width: 80px; height: 80px;">
                            <i class="fas fa-user-clock"></i>
                        </div>
                        <h6 class="text-cyber mb-2">NO RECOGNITIONS YET</h6>
                        <p class="text-light">Students will appear here as they are recognized</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Info -->
        <div class="col-lg-4">
            <div class="session-info-panel">
                <h5 class="cyber-text mb-4">
                    <i class="fas fa-info-circle me-2"></i>SESSION INFORMATION
                </h5>
                
                <div class="row g-3 mb-4">
                    <div class="col-12">
                        <div class="info-card">
                            <div class="info-value">{{ module_code }}</div>
                            <div class="info-label">MODULE CODE</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="info-card">
                            <div class="info-value" id="currentDate">{{ now.strftime('%Y-%m-%d') if now else '' }}</div>
                            <div class="info-label">DATE</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="info-card">
                            <div class="info-value" id="currentTime">{{ now.strftime('%H:%M:%S') if now else '' }}</div>
                            <div class="info-label">TIME</div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="info-card" style="background: rgba(0, 255, 136, 0.1); border-color: rgba(0, 255, 136, 0.3);">
                            <div class="info-value" style="color: var(--terminal-green);">ACTIVE</div>
                            <div class="info-label">SESSION STATUS</div>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2">
                    <a href="{{ url_for('view_attendance', module_id=module_id) }}" class="btn-module">
                        <i class="fas fa-list me-2"></i> VIEW ATTENDANCE RECORDS
                    </a>
                    <a href="{{ url_for('take_attendance_enhanced', module_id=module_id) }}" class="btn-module">
                        <i class="fas fa-sync-alt me-2"></i> CONTINUOUS MODE
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function updateTime() {
    const now = new Date();
    document.getElementById('currentTime').textContent = now.toLocaleTimeString();
}
setInterval(updateTime, 1000);

function markAttendance() {
    const resultsDiv = document.getElementById('recognitionResults');
    const faceStatus = document.getElementById('faceStatus');
    
    // Show processing
    faceStatus.className = 'status-indicator status-processing';
    faceStatus.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> PROCESSING FACE RECOGNITION...';
    
    fetch('/mark-attendance-face', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            module_id: {{ module_id }}
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            faceStatus.className = 'status-indicator status-success';
            faceStatus.innerHTML = '<i class="fas fa-check-circle"></i> ATTENDANCE MARKED SUCCESSFULLY!';
            
            // Add to recognition results
            const resultHtml = `
                <div class="result-item">
                    <div class="student-avatar-small">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="text-light mb-1">${data.student_name}</h6>
                        <small class="text-terminal">Recognized via Face ID</small>
                    </div>
                    <div class="text-end">
                        <small class="text-muted d-block">${new Date().toLocaleTimeString()}</small>
                        <span class="face-status-badge face-registered">
                            <i class="fas fa-check me-1"></i>PRESENT
                        </span>
                    </div>
                </div>
            `;
            
            if (resultsDiv.querySelector('.text-center')) {
                resultsDiv.innerHTML = resultHtml;
            } else {
                resultsDiv.innerHTML = resultHtml + resultsDiv.innerHTML;
            }
            
            // Show success message
            showAlert('success', 'SUCCESS!', data.message);
            
        } else {
            faceStatus.className = 'status-indicator status-error';
            faceStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> RECOGNITION FAILED';
            
            // Show error message
            showAlert('danger', 'RECOGNITION FAILED', data.message);
        }
    })
    .catch(error => {
        faceStatus.className = 'status-indicator status-error';
        faceStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> CONNECTION ERROR';
        
        showAlert('danger', 'CONNECTION ERROR', 'Please check your connection and try again.');
    });
}

function showAlert(type, title, message) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show mt-3 border-0`;
    alert.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} fa-2x text-${type} me-3"></i>
            <div>
                <h6 class="fw-bold mb-1">${title}</h6>
                <p class="mb-0">${message}</p>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" style="filter: invert(1);"></button>
    `;
    document.querySelector('.attendance-session-container').prepend(alert);
}
</script>
{% endblock %}