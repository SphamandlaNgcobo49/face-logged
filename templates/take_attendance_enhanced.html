<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Attendance - {{ module_code }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .video-container {
            position: relative;
            max-width: 800px;
            margin: 0 auto;
            border: 3px solid #2E8B57;
            border-radius: 10px;
            overflow: hidden;
        }
        .status-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 10;
        }
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        .student-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .btn-success {
            background-color: #2E8B57;
            border-color: #2E8B57;
        }
        .btn-success:hover {
            background-color: #3CB371;
            border-color: #3CB371;
        }
        .card {
            border: 1px solid #2E8B57;
            box-shadow: 0 2px 4px rgba(46, 139, 87, 0.1);
        }
        .card-header {
            background-color: #2E8B57;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-camera"></i> Continuous Face Recognition - {{ module_name }}</h4>
                    </div>
                    <div class="card-body">
                        <div class="video-container">
                            <img src="{{ url_for('video_feed_continuous', module_id=module_id) }}" 
                                 width="100%" alt="Video Feed">
                        </div>
                        
                        <div class="controls">
                            <button id="startBtn" class="btn btn-success btn-lg me-3">
                                <i class="fas fa-play"></i> Start Attendance Session
                            </button>
                            <button id="stopBtn" class="btn btn-danger btn-lg" disabled>
                                <i class="fas fa-stop"></i> Finish Attendance Session
                            </button>
                        </div>
                        
                        <div id="statusMessage" class="alert alert-info text-center"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-users"></i> Enrolled Students ({{ enrolled_students|length }})</h5>
                    </div>
                    <div class="card-body student-list">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Face Registered</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for student in enrolled_students %}
                                    <tr>
                                        <td>{{ student[1] }} {{ student[2] }}</td>
                                        <td>
                                            {% if student[3] %}
                                                <span class="badge bg-success">Yes</span>
                                            {% else %}
                                                <span class="badge bg-warning">No</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> How It Works</h5>
                    </div>
                    <div class="card-body">
                        <ol class="small">
                            <li><strong>Click "Start Attendance Session"</strong> to begin automatic face detection</li>
                            <li>Students should face the camera clearly in good lighting</li>
                            <li>System automatically detects and marks attendance in real-time</li>
                            <li>Each student is detected only once per session (10-second cooldown)</li>
                            <li><strong>Click "Finish Attendance Session"</strong> when class ends</li>
                            <li>Low attendance alerts are sent automatically after session ends</li>
                        </ol>
                        <div class="alert alert-warning small">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Note:</strong> This is a demo system. In production, use proper face recognition libraries.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('startBtn').addEventListener('click', function() {
            const startBtn = this;
            const stopBtn = document.getElementById('stopBtn');
            const statusMessage = document.getElementById('statusMessage');
            
            fetch(`/start-attendance/{{ module_id }}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        statusMessage.textContent = data.message;
                        statusMessage.className = 'alert alert-success text-center';
                        startBtn.disabled = true;
                        stopBtn.disabled = false;
                        
                        // Update status every 5 seconds
                        const statusInterval = setInterval(() => {
                            statusMessage.textContent = `Session active - Detecting faces automatically...`;
                        }, 5000);
                        
                        // Store interval ID for cleanup
                        stopBtn.dataset.intervalId = statusInterval;
                    } else {
                        statusMessage.textContent = data.message;
                        statusMessage.className = 'alert alert-danger text-center';
                    }
                })
                .catch(error => {
                    statusMessage.textContent = 'Error starting attendance session';
                    statusMessage.className = 'alert alert-danger text-center';
                    console.error('Error:', error);
                });
        });

        document.getElementById('stopBtn').addEventListener('click', function() {
            const startBtn = document.getElementById('startBtn');
            const stopBtn = this;
            const statusMessage = document.getElementById('statusMessage');
            
            // Clear status update interval
            if (stopBtn.dataset.intervalId) {
                clearInterval(stopBtn.dataset.intervalId);
            }
            
            fetch(`/stop-attendance/{{ module_id }}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    statusMessage.textContent = data.message;
                    if (data.success) {
                        statusMessage.className = 'alert alert-info text-center';
                    } else {
                        statusMessage.className = 'alert alert-danger text-center';
                    }
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    
                    // Refresh page after 5 seconds to show updated attendance
                    setTimeout(() => {
                        window.location.href = "{{ url_for('view_attendance', module_id=module_id) }}";
                    }, 5000);
                })
                .catch(error => {
                    statusMessage.textContent = 'Error stopping attendance session';
                    statusMessage.className = 'alert alert-danger text-center';
                    console.error('Error:', error);
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                });
        });
    </script>
</body>
</html>